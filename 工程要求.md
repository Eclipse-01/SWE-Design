# 软件工程课程设计任务书：智能教学辅助系统(IntelliTeach) - 完整开发版

**版本号**：V2.0 (SaaS多租户增强版)  
**文档用途**：AI Agent开发指令/软件工程课程设计报告大纲核心评分点对齐

## 核心评分点

- **新颖性 (15%)**：SaaS多租户架构 + 生成式AI (Gemini) 深度集成
- **健壮性 (5%)**：全链路 Zod 校验 + Error Boundary + 事务回滚机制
- **文档 (40%)**：完全对应实验一至实验四的输出要求

---

## 1. 项目概述与架构定义

### 1.1 项目目标

开发一个基于 Next.js App Router 的企业级 SaaS 教学管理平台。系统支持多组织（如“江南大学”、“复旦大学”）隔离管理。**系统采用“课程-作业”二级管理架构**，管理员配置组织的 AI 订阅额度，教师创建课程并发布作业，系统利用 Google Gemini API 实现作业的自动化批改与反馈。

### 1.2 技术栈（强制约束）

- **Framework**：Next.js 14+ (App Router, Server Actions)
- **Language**：TypeScript (Strict Mode)
- **UI System**：ShadCN UI (基于 Radix UI + Tailwind CSS)
- **Database**：PostgreSQL (Supabase 或 Vercel Postgres)
- **ORM**：Prisma (Schema定义见下文)
- **AI Engine**：Google Gemini API (gemini-2.5-flash)
- **Auth**：NextAuth.js/Auth.js (v5)
- **Forms**：React Hook Form + Zod (Schema Validation)

---

## 2. 数据库设计（Prisma Schema规范）

AI Agent需严格按照此Schema生成数据库迁移文件。

### 核心枚举定义

```prisma
enum UserRole {
  SUPER_ADMIN // 系统超级管理员
  TEACHER     // 教师
  STUDENT     // 学生
}

enum UserStatus {
  ACTIVE      // 正常
  BANNED      // 封禁(无法登录)
  PENDING     // 待激活
}

enum SubscriptionStatus {
  ACTIVE      // 订阅生效中
  EXPIRED     // 已过期
  INACTIVE    // 未订阅
}

enum AssignmentStatus {
  DRAFT       // 草稿
  PUBLISHED   // 已发布
  ARCHIVED    // 已归档
}

enum SubmissionStatus {
  PENDING     // 未提交
  SUBMITTED   // 已提交
  GRADED      // 已批改
}
```

### 组织表（多租户核心）

```prisma
model Organization {
  idString        String   @id @default(uuid())
  name            String   @unique // 如 "江南大学"
  domain          String?  // 如 "@jiangnan.edu.cn" (可选，用于自动归属)
  // AI订阅控制
  aiSubStatus     SubscriptionStatus @default(INACTIVE)
  aiSubEndDate    DateTime?
  aiTokenLimit    Int       @default(100000) // 每月Token上限
  aiTokenUsage    Int       @default(0)      // 当前已用
  users           User[]
  courses         Course[] // 新增：组织下的课程
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}
```

### 用户表

```prisma
model User {
  id               String     @id @default(uuid())
  name             String
  email            String     @unique
  passwordHash     String
  avatarUrl        String?
  role             UserRole   @default(STUDENT)
  status           UserStatus @default(ACTIVE)
  // 归属组织
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [idString])
  // 关系
  coursesOwned     Course[]     @relation("TeacherCourses") // 教师创建的课程
  enrollments      Enrollment[] // 学生参与的课程
  submissions      Submission[] // 学生的提交
  createdAt        DateTime     @default(now())
}
```

### 课程表（新增核心实体）

```prisma
model Course {
  idString        String   @id @default(uuid())
  name            String   // 如 "软件工程2024秋"
  code            String   // 课程代码，如 "SE101"
  description     String?  @db.Text
  archived        Boolean  @default(false)
  
  // 归属
  teacherId       String
  teacher         User     @relation("TeacherCourses", fields: [teacherId], references: [id])
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [idString])
  
  // 关系
  assignments     Assignment[]
  enrollments     Enrollment[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}
```

### 选课关联表（新增）

```prisma
model Enrollment {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  courseId  String
  course    Course   @relation(fields: [courseId], references: [idString])
  joinedAt  DateTime @default(now())

  @@unique([userId, courseId]) // 防止重复选课
}
```

### 作业表

```prisma
model Assignment {
  id               String            @id @default(uuid())
  title            String
  description      String            @db.Text // 富文本内容
  attachments      String[]          // 附件URL列表
  deadline         DateTime
  maxScore         Int               @default(100)
  status           AssignmentStatus  @default(DRAFT)
  
  // 关联课程而非直接关联教师
  courseId         String
  course           Course            @relation(fields: [courseId], references: [idString])
  
  submissions      Submission[]
  createdAt        DateTime          @default(now())
}
```

### 提交与评分表

```prisma
model Submission {
  id               String           @id @default(uuid())
  content          String           @db.Text // 学生填写的文本
  fileUrls         String[]         // 学生上传的文件
  status           SubmissionStatus @default(SUBMITTED)
  submittedAt      DateTime         @default(now())
  // 评分结果
  score            Int?
  teacherFeedback  String?          @db.Text // AI分析结果(存JSON)
  aiAnalysis       Json?            // {"strengths":[], "weaknesses":[], "suggestion":""}
  studentId        String
  student          User             @relation(fields: [studentId], references: [id])
  assignmentId     String
  assignment       Assignment       @relation(fields: [assignmentId], references: [id])
}
```

---

## 3. 页面路由规划 (App Router)

所有页面必须实现响应式布局（Mobile First），PC端显示完整表格，移动端使用Card或折叠视图。

### 3.1 公共/基础层

- `/`：Landing Page（Hero Section，功能特性，定价方案模拟）
- `/login`：登录页（ShadCN Card，表单校验）
- `/register`：注册页（需输入组织邀请码或选择组织）
- `/unauthorized`：403页面（当被封禁或权限不足时跳转）

### 3.2 超级管理员端 `/admin` - ShadCN Admin Layout

- `/admin/dashboard`：全景概览（卡片展示：总组织数、活跃用户、AI Token消耗总量）
- `/admin/organizations`：组织管理列表（DataTable，支持搜索）
  - Actions：创建组织、编辑订阅（续费/暂停）
- `/admin/users`：全局用户管控
  - Feature：批量导入（CSV Upload -> Parse -> Preview -> Commit）
  - Feature：封禁/解禁（Switch Toggle，触发Server Action更新状态）

### 3.3 教师端 `/teacher` - Sidebar Layout

- `/teacher/dashboard`：教学概览（活跃课程卡片、近期截止作业）
- `/teacher/courses`：课程管理
  - `/create`：创建新课程（输入课程名、代码、简介）
  - `/[courseId]`：**课程详情页（核心入口）**
    - Tab: **作业管理** (发布/编辑作业)
    - Tab: **学生管理** (查看选课名单、移除学生)
    - Tab: **设置** (归档课程)
- `/teacher/courses/[courseId]/assignments/[assignmentId]`：作业详情与批改列表
- `/teacher/grading/[subId]`：沉浸式批改台（核心页面）
  - Layout：ResizablePanel（左侧学生作业，右侧评分表单+AI助手）

### 3.4 学生端 `/student` - Mobile Friendly Layout

- `/student/dashboard`：学习中心（显示我参与的课程列表）
- `/student/courses`：选课中心
  - `/join`：输入课程码加入课程
  - `/[courseId]`：课程主页（显示该课程下的作业列表）
- `/student/assignments/[id]`：写作业/上传
- `/student/submissions/[id]`：反馈报告（查看分数、AI评语、教师评语）

---

## 4. 核心功能详细开发指令

### 4.1 身份与权限 (Middleware)

- JWT策略：Session中必须包含 role, orgId, status
- 中间件拦截：
  - 如果 status === 'BANNED'，强制登出或重定向至 `/unauthorized`
  - `/admin` 路由仅允许 role === 'SUPER_ADMIN' 访问
- 数据隔离：
  - Admin/Teacher 查询时需校验 `organizationId`。
  - **课程权限**：Teacher 只能操作自己创建的 Course (`where: { teacherId: session.userId }`)。
  - **作业权限**：Student 只能查看已 Enroll 的 Course 下的 Assignment。

### 4.2 管理员功能：批量导入与封禁

- CSV解析：前端使用 papaparse 解析CSV文件（name, email, role）
- 事务写入：

```typescript
// Server Action伪代码
await prisma.$transaction(async (tx) => {
  for (const row of rows) {
    await tx.user.create({ ... })
  }
})
```

- 封禁逻辑：点击封禁后，除了更新数据库，若有Redis黑名单，需同步写入（可选）

### 4.3 AI批改与订阅守卫 (Subscription Guard)

- 调用前置检查：在调用Gemini API的Server Action顶部：

```typescript
throw new Error("AI 服务额度已耗尽或订阅过期，请联系管理员。");
```

- Prompt Engineering (JSON Mode)：

```
System: You are an academic grading assistant.
Task: Grade the following submission based on requirements.
Format: Respond ONLY with valid JSON.
Schema: {
  "score": number (0-100),
  "feedback": string (comprehensive analysis),
  "strengths": string[],
  "weaknesses": string[]
}
```

---

## 5. UI/UX设计规范 (Fluent Design + Tailwind)

### 5.1 样式配置

- **设计语言**：采用 Fluent Design，强调光感、深度和动态效果。
- **Font**：Segoe UI（默认字体），JetBrains Mono（代码字体）。
- **Theme**：支持 Light/Dark 模式切换，使用 Fluent Design 的主题色板。
- **Color Palette**：基于 Fluent Design 的 Acrylic 和 Mica 效果，背景使用半透明渐变。
- **动态效果**：交互组件需添加平滑的动画过渡（如 `transition-all`），并使用阴影和高光增强层次感。

### 5.2 关键组件映射

- **表格**：`ui/data-table` (TanStack Table) - 用于Admin用户列表，支持分页、排序、列可见性切换，表头使用 Fluent Design 的 Command Bar 风格。
- **弹窗**：`ui/dialog` - 弹窗背景需使用 Fluent Design 的 Acrylic 模糊效果。
- **警告**：`ui/alert-dialog` - 警告框需带有轻微的阴影和高光，按钮使用 Fluent Design 的悬浮效果。
- **表单**：`ui/form` (React Hook Form) - 输入框需带有 Fluent Design 的光感边框，聚焦时边框颜色动态变化。
- **反馈**：`ui/sonner` (Toast) - 右下角弹出通知需带有透明背景和阴影。
- **下拉菜单**：`ui/dropdown-menu` - 菜单项需带有悬浮效果，选中项高亮显示。

### 5.3 桌面端侧边栏设计

- **布局要求**：桌面端统一采用侧边栏布局，侧边栏固定在左侧，背景使用 Fluent Design 的 Mica 效果。
- **功能导航**：
  - **超级管理员**：
    - Dashboard（全景概览）
    - 组织管理
    - 用户管理
    - 系统设置
  - **教师**：
    - **我的课程** (列出所有活跃课程，点击进入课程专属上下文)
    - 待批改 (跨课程聚合所有待批改作业)
    - 课程归档
    - 个人设置
  - **学生**：
    - **我的课堂** (Grid视图展示所有课程)
    - 待办作业 (跨课程聚合)
    - 成绩单
    - 个人设置
- **交互设计**：
  - **面包屑导航**：进入特定课程后，顶部需显示面包屑 `我的课程 > 软件工程 > 作业1`，方便快速返回。
  - 当前选中的功能项高亮显示（使用 Fluent Design 的光感效果）。
  - 支持折叠/展开侧边栏（使用 `ui/collapsible` 组件）。
  - 在移动端隐藏侧边栏，改为顶部导航菜单（使用 `ui/sheet` 组件）。

---

## 6. 健壮性与防御性编程（对应5%评分）

### 6.1 输入校验（Zod）

任何Server Action的入参必须经过Zod校验：

```typescript
const CreateAssignmentSchema = z.object({
  title: z.string().min(2, "标题至少2个字"),
  maxScore: z.coerce.number().min(1).max(100),
  deadline: z.date().refine((date) => date > new Date(), "截止时间必须在未来"),
});
```

### 6.2 错误边界（Error Boundaries）

- 在 `app/dashboard/error.tsx` 中捕获数据库连接失败或API 500错误，显示友好的“系统繁忙”界面及重试按钮
- 在AI调用失败时，捕获异常并返回 `StandardResponse.error("AI服务暂时不可用，请稍后重试")`，而不是让整个页面崩溃

---

## 7. 课程设计文档撰写指南（按此输出文档）

- **实验一：软件需求规格说明书 (SRS)**
  - 用例图：绘制Admin（管理组织/用户）、Teacher（发布/批改）、Student（提交/查看）三大角色的Use Case
  - 功能描述：详细描述“AI订阅扣费逻辑”和“多租户数据隔离需求”
- **实验二：软件系统设计 (SDD)**
  - E-R图：基于上述Prisma Schema绘制实体关系图
  - 架构图：展示Next.js Client Component -> Server Action -> Prisma -> DB的数据流
  - 界面设计：截取ShadCN风格的Dashboard和Mobile端的Sheet导航菜单
- **实验三：系统实现**
  - 核心算法：展示 Subscription Guard（订阅守卫）的代码片段
  - AI集成：展示Gemini API的Prompt构建和JSON解析代码
- **实验四：软件测试**
  - 边界测试：
    1. 当组织Token耗尽时，尝试使用AI批改 -> 预期：报错提示
    2. 上传非CSV格式文件进行批量导入 -> 预期：Zod报错
    3. 封禁用户后，该用户尝试刷新页面 -> 预期：跳转至Login或Forbidden
