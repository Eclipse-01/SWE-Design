// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  TEACHER
  STUDENT
}

enum UserStatus {
  ACTIVE
  BANNED
  PENDING
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  INACTIVE
}

enum AssignmentStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum SubmissionStatus {
  PENDING
  SUBMITTED
  GRADED
}

model Organization {
  idString        String   @id @default(uuid())
  name            String   @unique
  aiSubStatus     SubscriptionStatus @default(INACTIVE)
  aiSubEndDate    DateTime?
  aiTokenLimit    Int       @default(100000)
  aiTokenUsage    Int       @default(0)
  users           User[]
  courses         Course[]
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model User {
  id               String     @id @default(uuid())
  name             String
  email            String     @unique
  passwordHash     String
  avatarUrl        String?
  role             UserRole   @default(STUDENT)
  status           UserStatus @default(ACTIVE)
  organizationId   String?
  organization     Organization? @relation(fields: [organizationId], references: [idString])
  coursesOwned     Course[]     @relation("TeacherCourses")
  enrollments      Enrollment[]
  submissions      Submission[]
  createdAt        DateTime     @default(now())
}

model Course {
  idString        String   @id @default(uuid())
  name            String
  code            String   @unique
  description     String?  @db.Text
  archived        Boolean  @default(false)
  teacherId       String
  teacher         User     @relation("TeacherCourses", fields: [teacherId], references: [id])
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [idString])
  assignments     Assignment[]
  enrollments     Enrollment[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Enrollment {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  courseId  String
  course    Course   @relation(fields: [courseId], references: [idString])
  joinedAt  DateTime @default(now())

  @@unique([userId, courseId])
}

model Assignment {
  id               String            @id @default(uuid())
  title            String
  description      String            @db.Text
  deadline         DateTime
  maxScore         Int               @default(100)
  status           AssignmentStatus  @default(DRAFT)
  courseId         String
  course           Course            @relation(fields: [courseId], references: [idString])
  submissions      Submission[]
  createdAt        DateTime          @default(now())
}

model Submission {
  id               String           @id @default(uuid())
  content          String           @db.Text
  fileUrls         String[]
  status           SubmissionStatus @default(SUBMITTED)
  submittedAt      DateTime         @default(now())
  score            Int?
  teacherFeedback  String?          @db.Text
  aiAnalysis       Json?
  studentId        String
  student          User             @relation(fields: [studentId], references: [id])
  assignmentId     String
  assignment       Assignment       @relation(fields: [assignmentId], references: [id])
}
